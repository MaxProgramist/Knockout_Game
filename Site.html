<!DOCTYPE html>
<html>
<style>
    .joinRoomCodeInput {
        text-align: center;
    }

    .joinRoomCodeButton {
        text-align: center;
    }

    .nicknameInput {
        text-align: center;
    }

    .makeRoomCodeInput {
        text-align: center;
    }

    .countOfPlayersInput {
        text-align: center;
    }

    .errorBox {
        z-index: 10;
        background-color: #73eaff;
        width: 150px;
        height: 100px;

        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);

        align-content: center;
        text-align: center;
        padding: 10px 10px 10px 10px;
    }

    .errorBoxButton {
        position: absolute;
        top: 1%;
        right: 1%;
        height: 20px;
        width: 20px;
        background: #458c99;
        border: none;
    }


    .title {
        user-select: none;
    }

    .title,
    .joinRoomCode,
    .nickname,
    .joinRoomButton,
    .makeRoomCode,
    .countOfPlayers,
    .makeRoomButton,
    .makeRandomRoom {
        text-align: center;
    }

    .joinRoomButton,
    .makeRoomButton,
    .makeRandomRoom {
        user-select: none;
    }
</style>

<head>
    <title> Knockout </title>
</head>

<body>
    <p class="title"> Knockout game! </p>

    <p class="joinRoomCode"> Code <br> <input class="joinRoomCodeInput" type="text" size="4" maxlength="4"
            name="joinRoomCodeInput" id="joinRoomCodeInput"> <br> </p>

    <p class="nickname"> Nickname <br> <input class="nicknameInput" type="text" size="16" maxlength="16"
            name="nicknameInput" id="nicknameInput"> <br> </p>

    <div class="joinRoomButton">
        <button class="joinRoomCodeButton" type="button" name="joinRoomCodeButton" id="joinRoomCodeButton"
            onclick="joinRoom()">
            Conect room <br>
    </div>


    <p class="makeRoomCode"> Code <br> <input class="makeRoomCodeInput" type="text" size="4" maxlength="4"
            name="makeRoomCodeInput" id="makeRoomCodeInput">
    </p>
    <div class="makeRandomRoom">
        <button class="makeRandomRoomCodeButton" type="button" name="makeRandomRoomCodeButton"
            id="makeRandomRoomCodeButton" onclick="makeRandomRoomCode()">
            Make random code <br>
    </div>

    <p class="countOfPlayers"> Count of players <br> <input class="countOfPlayersInput" type="number" size="16"
            maxlength="16" name="countOfPlayersInput" id="countOfPlayersInput" max="199" min="4"> <br> </p>

    <div class="makeRoomButton">
        <button class="makeRoomCodeButton" type="button" name="makeRoomCodeButton" id="makeRoomCodeButton"
            onclick="makeRoom()">
            Make room <br>
    </div>

    <div class="resetButton">
        <button class="resetDevButton" type="button" name="resetDevButton" id="resetDevButton" onclick="resetData()">
            Reset <br>
    </div>

    <script>

        const joinRoomCodeInput = document.getElementById('joinRoomCodeInput');
        const nicknameInput = document.getElementById('nicknameInput');
        const makeRoomCodeInput = document.getElementById('makeRoomCodeInput');
        const countOfPlayersInput = document.getElementById('countOfPlayersInput');

        const api = 'https://sitebackend-ebr5.onrender.com/data';

        async function joinRoom() {
            const joinRoomCodeValue = joinRoomCodeInput.value;
            const nicknameValue = nicknameInput.value;

            if (joinRoomCodeValue.length < 4) return popUpWindowOfErroe("Incorect code type");
            if (nicknameValue.length < 1) return popUpWindowOfErroe("Incorect nickname type");

            for (let i = 0; i < joinRoomCodeValue.length; i++) {
                const charCode = joinRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return popUpWindowOfErroe("Incorect code type");
            }

            let payload = await loadData();

            if (payload.roomsCodes.includes(joinRoomCodeValue)) {
                if (payload.rooms[joinRoomCodeValue].countOfPlayers <= payload.rooms[joinRoomCodeValue].players.length)
                    return popUpWindowOfErroe("Too many players in room");
                const newPlayer = {
                    "name": nicknameValue,
                    "skin": 2,
                    "enemy": "None",
                    "tasks": "None"
                }
                payload.rooms[joinRoomCodeValue].players.push(newPlayer);
            }
            else return popUpWindowOfErroe("Wrong room code");

            saveData(payload);
        }

        async function makeRoom() {
            const makeRoomCodeValue = makeRoomCodeInput.value;
            const roomPlayersCount = countOfPlayersInput.value;

            if (makeRoomCodeValue.length < 4) return popUpWindowOfErroe("Incorect code type");
            if (roomPlayersCount < 4) return popUpWindowOfErroe("Count of players is to small (at least 4)");

            for (let i = 0; i < makeRoomCodeValue.length; i++) {
                const charCode = makeRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return popUpWindowOfErroe("Incorect code type");
            }

            if (payload.roomsCodes.includes(joinRoomCodeValue)) return popUpWindowOfErroe("Room is already created!");

            let payload = await loadData();

            const newRoom = {
                "countOfPlayers": 0,
                "players": []
            };

            payload.roomsCodes.push(makeRoomCodeValue);
            payload.rooms[joinRoomCodeValue] = newRoom;
            payload.rooms[joinRoomCodeValue].countOfPlayers = roomPlayersCount;
        }

        async function makeRandomRoomCode() {
            let payload = await loadData();

            let curentRoomCode = randomString(4);

            while (payload.roomsCodes.includes(curentRoomCode)) {
                curentRoomCode = randomString(4);
            }

            makeRoomCodeInput.value = `${curentRoomCode}`;
        }

        function popUpWindowOfErroe(errorType) {
            let errorBox = document.createElement("div");
            errorBox.setAttribute('class', 'errorBox');

            let closeButton = document.createElement("button");
            closeButton.textContent = "X";
            closeButton.setAttribute('class', 'errorBoxButton');
            closeButton.onclick = function () {
                errorBox.remove();
            };

            errorBox.innerHTML += `Error: <br> ${errorType} <br>`;
            errorBox.appendChild(closeButton);

            document.body.appendChild(errorBox);
        }

        //Check the data: https://sitebackend-ebr5.onrender.com/data

        // Never chaged functions

        function randomString(length) {
            let result = '';
            const characters = '0123456789';

            for (let i = 0; i < length; i++) {
                const randomInd = Math.floor(Math.random() * characters.length);
                result += characters.charAt(randomInd);
            }

            return result;
        }

        async function loadData() {
            const res = await fetch(api);
            const data = await res.json();
            return data;
        }

        async function saveData(payload) {
            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

        async function resetData() {
            let payload = {
                roomsCodes: [],
                rooms: {}
            };

            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

    </script>
</body>

</html>