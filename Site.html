<!DOCTYPE html>
<html>
<style>
    .roomCodeInput {
        background-color: #bbbbbb;
        text-align: center;
    }

    .roomCodeButton {
        background-color: #cccccc;
        text-align: center;
    }

    .nicknameInput {
        background-color: #999999;
        text-align: center;
    }

    .errorBox {
        z-index: 10;
        background-color: #73eaff;
        width: 150px;
        height: 100px;

        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);

        align-content: center;
        text-align: center;
        padding: 10px 10px 10px 10px;
    }

    .errorBoxButton {
        position: absolute;
        height: 30px;
        width: 30px;
        background: rgba(0, 0, 0, 0);
        border: none;
    }


    .title {
        user-select: none;
        text-align: center;
    }

    .roomCode {
        text-align: center;
    }

    .nickname {
        text-align: center;
    }

    .roomButton {
        user-select: none;
        text-align: center;
    }
</style>

<head>
    <title> Knockout </title>
</head>

<body>
    <p class="title"> Knockout game! </p>

    <p class="roomCode"> Code <br> <input class="roomCodeInput" type="text" size="4" maxlength="4" name="roomCodeInput"
            id="roomCodeInput"> <br> </p>

    <p class="nickname"> Nickname <br> <input class="nicknameInput" type="text" size="16" maxlength="16"
            name="nicknameInput" id="nicknameInput"> <br> </p>

    <div class="roomButton">
        <button class="roomCodeButton" type="button" name="roomCodeButton" id="roomCodeButton" onclick="joinRoom()">
            Conect <br>
    </div>

    <div class="resetButton">
        <button class="resetDevButton" type="button" name="resetDevButton" id="resetDevButton" onclick="resetData()">
            Reset <br>
    </div>

    <script>

        const roomCodeButton = document.getElementById('roomCodeButton');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const nicknameInput = document.getElementById('nicknameInput');

        const api = 'https://sitebackend-ebr5.onrender.com/data';

        async function joinRoom() {
            const roomCodeValue = roomCodeInput.value;
            const nicknameValue = nicknameInput.value;

            if (roomCodeValue.length < 4) return popUpWindowOfErroe("(ICT) Incorect code type");

            for (let i = 0; i < roomCodeValue.length; i++) {
                const charCode = roomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return popUpWindowOfErroe("(ICT) Incorect code type");
            }

            let payload = await loadData();

            if (payload.roomsCodes.includes(roomCodeValue)) {
                const newPlayer = {
                    "name": nicknameValue,
                    "skin": 2,
                    "enemy": "None",
                    "tasks": "None"
                }
                payload.rooms[roomCodeValue].push(newPlayer);
            }
            else {
                const newRoom = [
                    {
                        "name": nicknameValue,
                        "skin": 2,
                        "enemy": "None",
                        "tasks": "None"
                    }
                ];

                payload.roomsCodes.push(roomCodeValue);
                payload.rooms[roomCodeValue] = newRoom;
            }

            saveData(payload);
        }

        async function popUpWindowOfErroe(errorType) {
            let errorBox = document.createElement("div");
            errorBox.setAttribute('class', 'errorBox');

            let closeButton = document.createElement("button");
            closeButton.textContent = "X";
            closeButton.setAttribute('class', 'errorBoxButton');
            closeButton.onclick = function () {
                errorBox.remove();
            };
            errorBox.innerHTML += `Error: <br> ${errorType}`;
            errorBox.appendChild(closeButton);

            document.body.appendChild(errorBox);
        }

        //Check the data: https://sitebackend-ebr5.onrender.com/data

        // Never chaged functions

        async function loadData() {
            const res = await fetch(api);
            const data = await res.json();
            console.log(data);
            return data;
        }

        async function saveData(payload) {
            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

        async function resetData() {
            let payload = {
                roomsCodes: [],
                rooms: {}
            };

            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

    </script>
</body>

</html>