<!DOCTYPE html>
<html>
<style>
    .lobbyElements {
        --isVisible:visible; /* hidden / visible */
        visibility:var(--isVisible);
    }
    
    .joinRoomCodeInput {
        text-align: center;
    }

    .joinRoomCodeButton {
        text-align: center;
    }

    .nicknameInput {
        text-align: center;
    }

    .makeRoomCodeInput {
        text-align: center;
    }

    .countOfPlayersInput {
        text-align: center;
    }

    .errorBox {
        z-index: 10;
        background-color: #73eaff;
        width: 150px;
        height: 100px;

        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);

        align-content: center;
        text-align: center;
        padding: 10px 10px 10px 10px;
    }

    .errorBoxButton {
        position: absolute;
        top: 1%;
        right: 1%;
        height: 20px;
        width: 20px;
        background: #458c99;
        border: none;
    }


    .title {
        user-select: none;
    }

    .title,
    .joinRoomCode,
    .nickname,
    .joinRoomButton,
    .makeRoomCode,
    .countOfPlayers,
    .makeRoomButton,
    .makeRandomRoom {
        text-align: center;
    }

    .joinRoomButton,
    .makeRoomButton,
    .makeRandomRoom {
        user-select: none;
    }
</style>

<head>
    <title> Knockout </title>
</head>

<body>
    <p class="title lobbyElements"> Knockout game! </p>

    <p class="title lobbyElements"> Conect to room </p>

    <p class="joinRoomCode lobbyElements"> Code: <input class="joinRoomCodeInput" type="text" size="4" maxlength="4"
            name="joinRoomCodeInput" id="joinRoomCodeInput"> <br> </p>


    <p class="nickname lobbyElements"> Nickname: <input class="nicknameInput" type="text" size="16" maxlength="16"
            name="nicknameInput" id="nicknameInput"> <br> </p>

    <div class="joinRoomButton">
        <button class="joinRoomCodeButton" type="button" name="joinRoomCodeButton" id="joinRoomCodeButton"
            onclick="JoinRoom()">
            Conect to room <br>
    </div>

    <br>
    <p class="title"> Creat room </p>
    
    <div>
        <p class="makeRoomCode"> Code:
            <input class="makeRoomCodeInput" type="text" size="4" maxlength="4" name="makeRoomCodeInput"
                id="makeRoomCodeInput">
            <button class="makeRandomRoomCodeButton" type="button" name="makeRandomRoomCodeButton"
                id="makeRandomRoomCodeButton" onclick="MakeRandomRoomCode()">
                Random <br>
        </p>
    </div>

    <p class="countOfPlayers"> Count of players: <input class="countOfPlayersInput" type="number" size="16"
            maxlength="16" name="countOfPlayersInput" id="countOfPlayersInput" max="199" min="4"> <br> </p>

    <div class="makeRoomButton">
        <button class="makeRoomCodeButton" type="button" name="makeRoomCodeButton" id="makeRoomCodeButton"
            onclick="MakeRoom()">
            Make room <br>
    </div>

    <div class="resetButton">
        <button class="resetDevButton" type="button" name="resetDevButton" id="resetDevButton" onclick="ResetData()">
            Reset <br>
    </div>

    <script>

        var joinRoomCodeInput = document.getElementById('joinRoomCodeInput');
        var nicknameInput = document.getElementById('nicknameInput');
        var makeRoomCodeInput = document.getElementById('makeRoomCodeInput');
        var countOfPlayersInput = document.getElementById('countOfPlayersInput');

        const API = 'https://sitebackend-ebr5.onrender.com/data';

        async function JoinRoom() {
            const joinRoomCodeValue = joinRoomCodeInput.value;
            const nicknameValue = nicknameInput.value;

            if (joinRoomCodeValue.length < 4) return PopUpWindowOfError("Incorect code type");
            if (nicknameValue.length < 1) return PopUpWindowOfError("Incorect nickname type");

            for (let i = 0; i < joinRoomCodeValue.length; i++) {
                const charCode = joinRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return PopUpWindowOfError("Incorect code type");
            }

            let payload = await LoadData();

            if (payload.roomsCodes.includes(joinRoomCodeValue)) {
                if (payload.rooms[joinRoomCodeValue].countOfPlayers <= payload.rooms[joinRoomCodeValue].players.length)
                    return PopUpWindowOfError("Too many players in room");
                const newPlayer = {
                    "name": nicknameValue,
                    "skin": 2,
                    "enemy": "None",
                    "tasks": "None"
                }
                payload.rooms[joinRoomCodeValue].players.push(newPlayer);
            }
            else return PopUpWindowOfError("Wrong room code");

            SaveData(payload);
            document.joinRoomCodeInput.style.setProperty('--isVisible', 'hidden');
        }

        async function MakeRoom() {
            const makeRoomCodeValue = makeRoomCodeInput.value;
            const roomPlayersCount = countOfPlayersInput.value;

            if (makeRoomCodeValue.length < 4) return PopUpWindowOfError("Incorect code type");
            if (roomPlayersCount < 4) return PopUpWindowOfError("Count of players is to small (at least 4)");

            for (let i = 0; i < makeRoomCodeValue.length; i++) {
                const charCode = makeRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return PopUpWindowOfError("Incorect code type");
            }

            if (payload.roomsCodes.includes(joinRoomCodeValue)) return PopUpWindowOfError("Room is already created!");

            let payload = await LoadData();

            const newRoom = {
                "countOfPlayers": 0,
                "players": []
            };

            payload.roomsCodes.push(makeRoomCodeValue);
            payload.rooms[joinRoomCodeValue] = newRoom;
            payload.rooms[joinRoomCodeValue].countOfPlayers = roomPlayersCount;

            SaveData(payload);
            document.joinRoomCodeInput.style.setProperty('--isVisible', 'hidden');

            console.log("MAKE ROOM!");
        }

        async function MakeRandomRoomCode() {
            let payload = await LoadData();

            let curentRoomCode = RandomString(4);

            while (payload.roomsCodes.includes(curentRoomCode)) {
                curentRoomCode = RandomString(4);
            }

            makeRoomCodeInput.value = `${curentRoomCode}`;
        }

        function PopUpWindowOfError(errorType) {
            let errorBox = document.createElement("div");
            errorBox.setAttribute('class', 'errorBox');

            let closeButton = document.createElement("button");
            closeButton.textContent = "X";
            closeButton.setAttribute('class', 'errorBoxButton');
            closeButton.onclick = function () {
                errorBox.remove();
            };

            errorBox.innerHTML += `Error: <br> ${errorType} <br>`;
            errorBox.appendChild(closeButton);

            document.body.appendChild(errorBox);
        }

        //Check the data: https://sitebackend-ebr5.onrender.com/data

        // Never chaged functions

        function RandomString(length) {
            let result = '';
            const characters = '0123456789';

            for (let i = 0; i < length; i++) {
                const randomInd = Math.floor(Math.random() * characters.length);
                result += characters.charAt(randomInd);
            }

            return result;
        }

        async function LoadData() {
            const res = await fetch(API);
            const data = await res.json();
            return data;
        }

        async function SaveData(payload) {
            await fetch(API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

        async function ResetData() {
            let payload = {
                roomsCodes: [],
                rooms: {}
            };

            await fetch(API, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

    </script>
</body>

</html>
