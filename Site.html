<!DOCTYPE html>
<html>
<style>
    .joinRoomCodeInput {
        background-color: #bbbbbb;
        text-align: center;
    }

    .joinRoomCodeButton {
        background-color: #cccccc;
        text-align: center;
    }

    .nicknameInput {
        background-color: #999999;
        text-align: center;
    }

    .errorBox {
        z-index: 10;
        background-color: #73eaff;
        width: 150px;
        height: 100px;

        position: absolute;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);

        align-content: center;
        text-align: center;
        padding: 10px 10px 10px 10px;
    }

    .errorBoxButton {
        position: absolute;
        height: 30px;
        width: 30px;
        background: rgba(0, 0, 0, 0);
        border: none;
    }


    .title {
        user-select: none;
        text-align: center;
    }

    .joinRoomCode {
        text-align: center;
    }

    .nickname {
        text-align: center;
    }

    .joinRoomButton {
        user-select: none;
        text-align: center;
    }
</style>

<head>
    <title> Knockout </title>
</head>

<body>
    <p class="title"> Knockout game! </p>

    <p class="joinRoomCode"> Code <br> <input class="joinRoomCodeInput" type="text" size="4" maxlength="4"
            name="joinRoomCodeInput" id="joinRoomCodeInput"> <br> </p>

    <p class="nickname"> Nickname <br> <input class="nicknameInput" type="text" size="16" maxlength="16"
            name="nicknameInput" id="nicknameInput"> <br> </p>

    <div class="joinRoomButton">
        <button class="joinRoomCodeButton" type="button" name="joinRoomCodeButton" id="joinRoomCodeButton"
            onclick="joinRoom()">
            Conect <br>
    </div>

    <div class="resetButton">
        <button class="resetDevButton" type="button" name="resetDevButton" id="resetDevButton" onclick="resetData()">
            Reset <br>
    </div>

    <script>

        const joinRoomCodeButton = document.getElementById('joinRoomCodeButton');
        const joinRoomCodeInput = document.getElementById('joinRoomCodeInput');
        const nicknameInput = document.getElementById('nicknameInput');

        const api = 'https://sitebackend-ebr5.onrender.com/data';

        async function joinRoom() {
            const joinRoomCodeValue = joinRoomCodeInput.value;
            const nicknameValue = nicknameInput.value;

            if (joinRoomCodeValue.length < 4) return popUpWindowOfErroe("(ICT) Incorect code type");
            if (nicknameValue.length < 1) return popUpWindowOfErroe("(INT) Incorect nickname type");

            for (let i = 0; i < joinRoomCodeValue.length; i++) {
                const charCode = joinRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return popUpWindowOfErroe("(ICT) Incorect code type");
            }

            let payload = await loadData();

            if (payload.roomsCodes.includes(joinRoomCodeValue)) {
                if (payload.rooms[joinRoomCodeValue].countOfPlayers <= payload.rooms[joinRoomCodeValue].players.length) 
                    return popUpWindowOfErroe("Too many players in room");
                const newPlayer = {
                    "name": nicknameValue,
                    "skin": 2,
                    "enemy": "None",
                    "tasks": "None"
                }
                payload.rooms[joinRoomCodeValue].players.push(newPlayer);
            }
            else return popUpWindowOfErroe("(WRC) Wrong room code");

            saveData(payload);
        }

        async function makeRoom() {
            const makeRoomCodeValue = joinRoomCodeInput.value;
            const roomPlayersCount = nicknameInput.value;

            if (makeRoomCodeValue.length < 4) return popUpWindowOfErroe("(ICT) Incorect code type");
            if (roomPlayersCount < 5) return popUpWindowOfErroe("(INT) Count of players is to small");

            for (let i = 0; i < makeRoomCodeValue.length; i++) {
                const charCode = makeRoomCodeValue.charCodeAt(i);
                if (charCode < 48 || charCode > 57) return popUpWindowOfErroe("(ICT) Incorect code type");
            }

            let payload = await loadData();

            const newRoom = {
                "countOfPlayers": 0,
                "players": []
            };

            payload.roomsCodes.push(makeRoomCodeValue);
            payload.rooms[joinRoomCodeValue] = newRoom;
            payload.rooms[joinRoomCodeValue].countOfPlayers = roomPlayersCount;
        }

        async function popUpWindowOfErroe(errorType) {
            let errorBox = document.createElement("div");
            errorBox.setAttribute('class', 'errorBox');

            let closeButton = document.createElement("button");
            closeButton.textContent = "X";
            closeButton.setAttribute('class', 'errorBoxButton');
            closeButton.onclick = function () {
                errorBox.remove();
            };
            errorBox.innerHTML += `Error: <br> ${errorType}`;
            errorBox.appendChild(closeButton);

            document.body.appendChild(errorBox);
        }

        //Check the data: https://sitebackend-ebr5.onrender.com/data

        // Never chaged functions

        async function loadData() {
            const res = await fetch(api);
            const data = await res.json();
            console.log(data);
            return data;
        }

        async function saveData(payload) {
            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

        async function resetData() {
            let payload = {
                roomsCodes: [],
                rooms: {}
            };

            await fetch(api, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
        }

    </script>
</body>

</html>